import 'package:flutter/foundation.dart';

/// 提示词管理服务
/// 专门管理Enhance功能相关的提示词
class PromptService {
  // 私有构造函数，防止实例化
  PromptService._();

  /// 基础图片增强提示词（第二分类主功能）
  static const String basicEnhance = '''
请对这张照片进行AI智能增强处理：
1. 提升图片整体清晰度和细节，让图片更加锐利
2. 优化色彩饱和度、对比度和亮度，使色彩更加鲜艳自然
3. 减少图片噪点，增强质感和层次感
4. 如果包含人像，保持人物面部特征自然，优化肌肤质感
5. 增强图片的视觉效果，但避免过度处理导致失真
6. 保持原始图片的构图和主体内容不变
请返回高质量的增强版本图片。
''';

  /// ImageEnhancePage底部工具的提示词

  /// 背景模糊工具
  static const String backgroundBlur = '''
请对这张图片进行专业的背景模糊处理：
1. 精确识别图片中的主体对象（人物、动物或前景物体）
2. 保持主体完全清晰不变
3. 对背景进行自然的高斯模糊处理，创造专业的景深效果
4. 模糊程度适中，突出主体但不失真
5. 保持整体图片的色彩和光线平衡
请返回专业背景模糊效果的图片。
''';

  /// 色彩调整工具
  static const String colorAdjust = '''
请对这张图片进行色彩优化调整：
1. 优化整体色彩饱和度，让颜色更加鲜艳生动
2. 调整色温，让图片色调更加和谐自然
3. 增强对比度，让明暗层次更加分明
4. 调整亮度，让图片明亮度适中
5. 保持人物肌肤色彩自然，避免过度调色
请返回色彩优化后的图片。
''';

  /// 背景增强工具
  static const String backgroundEnhance = '''
请专门增强这张图片的背景部分：
1. 保持前景主体（人物或物体）不变
2. 增强背景的清晰度和细节
3. 优化背景的色彩和质感
4. 减少背景中的噪点和模糊
5. 让背景更加丰富有层次，但不抢夺主体风头
请返回背景增强后的图片。
''';

  /// 面部修饰工具
  static const String faceRetouch = '''
请对这张图片中的人像面部进行精细修饰：
1. 平滑肌肤质感，去除明显瑕疵（痘痘、斑点等）
2. 保持面部特征和表情完全自然，不要过度美化
3. 增强眼部亮度和清晰度
4. 优化面部光线，让肌肤更有光泽
5. 避免产生塑料感或假面效果
请返回自然修饰后的人像图片。
''';

  /// 面部增强工具
  static const String faceEnhance = '''
请增强这张图片中的人像面部效果：
1. 提升面部区域的整体清晰度和细节
2. 增强五官轮廓，让面部特征更加立体
3. 优化面部光影效果，增加层次感
4. 保持人物原始特征，只做质量提升
5. 让面部看起来更加精神和有活力
请返回面部增强后的人像图片。
''';

  /// 根据工具ID获取对应的提示词（旧版本，用于基础增强）
  /// [toolId] 工具ID：'basic_enhance', 'background_blur', 'colors', 'background_enhancer', 'face_retouch', 'face_enhancer'
  static String getPromptByToolId(String toolId) {
    switch (toolId) {
      case 'basic_enhance':
        return basicEnhance;
      case 'background_blur':
        return backgroundBlur;
      case 'colors':
        return colorAdjust;
      case 'background_enhancer':
        return backgroundEnhance;
      case 'face_retouch':
        return faceRetouch;
      case 'face_enhancer':
        return faceEnhance;
      default:
        debugPrint('⚠️ PromptService: 未知的工具ID: $toolId');
        return basicEnhance; // 默认返回基础增强提示词
    }
  }

  /// 获取特定工具和级别的精准提示词 (新版本，用于8级别处理)
  /// [toolId] 工具ID
  /// [level] 效果级别 (0-7)
  static String getToolLevelPrompt(String toolId, int level) {
    final key = '${toolId}_$level';
    final basePrompt = _levelPrompts[key] ?? _getDefaultPrompt(toolId, level);

    // Level 0 (Off) 不需要添加构图保持指令
    if (level == 0) {
      return basePrompt;
    }

    // 其他级别自动添加构图保持指令
    return _addCompositionProtection(basePrompt);
  }

  /// 为提示词添加统一的构图保持指令
  static String _addCompositionProtection(String basePrompt) {
    // 构图保持的核心指令 - 强化版本
    const compositionProtection = '''
🔥 【构图保持核心要求 - 最高优先级】：
1. ⚠️  CRITICAL: 严格保持原图构图，主体人物的位置绝对不能改变
2. ⚠️  CRITICAL: 人物必须保持在画面的原始位置，禁止向右侧或任何方向偏移
3. ⚠️  CRITICAL: 保持原有的画面比例和构图布局，不得裁剪、移动或重新构图
4. ⚠️  CRITICAL: 确保人物的脸部、身体在画面中的相对位置与原图100%一致
5. ⚠️  CRITICAL: 如果原图人物居中，处理后必须仍然居中，绝不能偏右

''';

    const keyRequirement = '''
🎯 【构图保护 - 绝对要求】：
- 主体位置和构图的保持是最高优先级，超越任何其他处理要求
- 如果无法在保持构图的前提下完成效果处理，优先保持构图
- 人物位置偏移是绝对禁止的，必须与原图位置100%一致
''';

    // 更强化的构图保护插入策略
    final lines = basePrompt.split('\n');
    final processedLines = <String>[];

    bool hasAddedProtection = false;
    for (int i = 0; i < lines.length; i++) {
      final line = lines[i].trim();

      // 在标题行后立即插入构图保护（最高优先级位置）
      if (!hasAddedProtection && line.endsWith('：')) {
        processedLines.add(lines[i]);
        processedLines.add(compositionProtection);
        hasAddedProtection = true;
        continue;
      }

      // 如果没有找到标题行，在第一个处理步骤前插入
      if (!hasAddedProtection && line.startsWith('1.')) {
        processedLines.add(compositionProtection);
        hasAddedProtection = true;
      }

      // 如果找到"请返回"开头的行，在其前面插入关键要求
      if (line.startsWith('请返回')) {
        processedLines.add(keyRequirement);
      }

      processedLines.add(lines[i]);
    }

    return processedLines.join('\n');
  }

  /// 40组精准提示词映射表
  static const Map<String, String> _levelPrompts = {
    // ==================== Background Blur 背景模糊系列 (0-7) ====================
    'background_blur_0': '''
保持图片完全原样，不应用任何背景模糊效果。
请返回与输入图片完全相同的图片。
''',

    'background_blur_1': '''
对这张图片进行轻微的背景模糊处理：
1. 精确识别图片中的主体对象（人物、动物或主要物体）
2. 保持主体完全清晰锐利，不受任何影响
3. 对背景进行轻微的高斯模糊处理，模糊强度约1.5-2.0
4. 创造自然的浅景深效果，突出主体但不过度
5. 保持整体图片的色彩和光线平衡
请返回轻微背景模糊效果的图片。
''',

    'background_blur_2': '''
对这张图片进行中等程度的背景模糊处理：
1. 精确识别并保护主体对象的完整清晰度
2. 对背景进行中等强度的高斯模糊，模糊强度约3.0-4.0
3. 创造明显的景深分离效果，主体更加突出
4. 确保模糊渐变自然，避免生硬的边缘
5. 增强整体的视觉层次感和专业感
请返回中等背景模糊效果的图片。
''',

    'background_blur_3': '''
对这张图片进行高强度的背景模糊处理：
1. 🔥 严格保持原图构图，主体人物在画面中的位置完全不变
2. 🔥 保持原有的画面比例和构图布局，不得裁剪或移动主体
3. 主体对象保持极高的清晰度和细节
4. 背景进行高强度模糊处理，模糊强度约5.0-6.5
5. 创造强烈的景深对比，背景几乎完全虚化
6. 主体与背景形成鲜明的焦点对比
7. 打造专业摄影的大光圈效果
🎯 关键要求：主体位置和构图绝对不能改变，只处理背景模糊效果。
请返回高强度背景模糊效果的图片。
''',

    'background_blur_4': '''
对这张图片进行极致的背景模糊处理：
1. 🔥 严格保持原图构图，主体人物在画面中的位置完全不变
2. 🔥 保持原有的画面比例和构图布局，不得裁剪或移动主体
3. 主体保持水晶般的清晰度
4. 背景进行极强模糊处理，模糊强度约7.0-8.5
5. 背景几乎完全虚化成柔和的色彩层
6. 创造梦幻般的景深效果
7. 主体如从背景中"跳出"的立体感
🎯 关键要求：主体位置和构图绝对不能改变，只处理背景模糊效果。
请返回极致背景模糊效果的图片。
''',

    'background_blur_5': '''
对这张图片进行专业级背景模糊处理：
1. 🔥 严格保持原图构图，主体人物在画面中的位置完全不变
2. 🔥 保持原有的画面比例和构图布局，不得裁剪或移动主体
3. 主体细节达到商业摄影级别的清晰度
4. 背景进行专业级深度模糊，模糊强度约9.0-10.5
5. 背景完全虚化为抽象的色彩和光影
6. 创造电影级别的景深分离效果
7. 达到顶级肖像摄影的专业标准
🎯 关键要求：主体位置和构图绝对不能改变，只处理背景模糊效果。
请返回专业级背景模糊效果的图片。
''',

    'background_blur_6': '''
对这张图片进行大师级背景模糊处理：
1. 🔥 严格保持原图构图，主体人物在画面中的位置完全不变
2. 🔥 保持原有的画面比例和构图布局，不得裁剪或移动主体
3. 主体达到艺术品级别的精细清晰度
4. 背景进行艺术级深度模糊，模糊强度约11.0-12.5
5. 背景转化为纯粹的色彩情感表达
6. 创造超现实的空间分离感
7. 达到国际摄影大师的作品水准
🎯 关键要求：主体位置和构图绝对不能改变，只处理背景模糊效果。
请返回大师级背景模糊效果的图片。
''',

    'background_blur_7': '''
对这张图片进行终极背景模糊处理：
1. 🔥 严格保持原图构图，主体人物在画面中的位置完全不变
2. 🔥 保持原有的画面比例和构图布局，不得裁剪或移动主体
3. 主体呈现超高清的完美细节
4. 背景进行终极深度模糊，模糊强度约13.0+
5. 背景完全抽象化为纯色彩和光线
6. 创造超越现实的艺术化效果
7. 主体仿佛悬浮在无限空间中
8. 达到艺术收藏级别的视觉冲击力
🎯 关键要求：主体位置和构图绝对不能改变，只处理背景模糊效果。
请返回终极背景模糊效果的图片。
''',

    // ==================== Colors 色彩增强系列 (0-7) ====================
    'colors_0': '''
保持图片的原始色彩，不进行任何色彩调整。
请返回与输入图片色彩完全相同的图片。
''',

    'colors_1': '''
对这张图片进行轻微的色彩优化：
1. 轻微提升整体色彩饱和度约10-15%
2. 微调色温，让图片更加温暖自然
3. 轻微增强对比度，让色彩层次更清晰
4. 保持人物肌肤色彩的自然真实
5. 整体提升约10%的视觉鲜活度
请返回轻微色彩优化的图片。
''',

    'colors_2': '''
对这张图片进行中等程度的色彩增强：
1. 提升色彩饱和度约20-30%
2. 优化色彩平衡，让各颜色更加和谐
3. 增强明暗对比度，让色彩更有层次
4. 调整高光和阴影的色彩表现
5. 让图片呈现更加生动的色彩效果
请返回中等色彩增强的图片。
''',

    'colors_3': '''
对这张图片进行高强度色彩增强：
1. 大幅提升色彩饱和度约35-45%
2. 强化色彩对比，让每种颜色更加突出
3. 优化色调分离，创造更丰富的色彩层次
4. 增强色彩的纯度和鲜艳度
5. 打造视觉冲击力强的色彩效果
请返回高强度色彩增强的图片。
''',

    'colors_4': '''
对这张图片进行极致色彩增强：
1. 极大提升色彩饱和度约50-60%
2. 创造极强的色彩对比和分离效果
3. 让每个色彩都达到最佳表现力
4. 优化色彩的明度和纯度到极致
5. 呈现超现实的色彩视觉体验
请返回极致色彩增强的图片。
''',

    'colors_5': '''
对这张图片进行专业级色彩处理：
1. 应用专业色彩分级技术
2. 创造电影级别的色调效果
3. 实现完美的色彩平衡和层次
4. 每个色彩通道都达到专业标准
5. 呈现商业广告级别的色彩质感
请返回专业级色彩处理的图片。
''',

    'colors_6': '''
对这张图片进行大师级色彩艺术化处理：
1. 应用艺术大师的色彩理论
2. 创造独特的色彩情感表达
3. 实现色彩的诗意化呈现
4. 每种色彩都具有深层的视觉含义
5. 达到艺术收藏品的色彩水准
请返回大师级色彩艺术化的图片。
''',

    'colors_7': '''
对这张图片进行终极色彩变革：
1. 重新定义图片的色彩语言
2. 创造超越现实的色彩体验
3. 每个像素的色彩都达到完美
4. 实现色彩的极致艺术化表达
5. 呈现令人窒息的色彩美学
6. 达到传世艺术品的色彩境界
请返回终极色彩变革的图片。
''',

    // ==================== Background Enhancer 背景增强系列 (0-7) ====================
    'background_enhancer_0': '''
保持背景完全原样，不进行任何背景增强处理。
请返回与输入图片背景完全相同的图片。
''',

    'background_enhancer_1': '''
对这张图片的背景进行轻微增强：
1. 保持前景主体完全不变
2. 轻微提升背景的清晰度和细节约15%
3. 增强背景色彩的饱和度和层次
4. 减少背景中的轻微噪点
5. 让背景更加丰富但不抢夺主体风头
请返回轻微背景增强的图片。
''',

    'background_enhancer_2': '''
对这张图片的背景进行中等程度增强：
1. 保持前景主体完全清晰不变
2. 显著提升背景的清晰度和纹理细节
3. 优化背景的色彩层次和对比度
4. 增强背景元素的立体感和质感
5. 让背景更加生动丰富有层次
请返回中等背景增强的图片。
''',

    'background_enhancer_3': '''
对这张图片的背景进行高强度增强：
1. 主体保持完美状态
2. 大幅增强背景的所有细节和纹理
3. 优化背景的光影效果和空间感
4. 让背景元素更加立体和真实
5. 创造丰富的背景视觉层次
请返回高强度背景增强的图片。
''',

    'background_enhancer_4': '''
对这张图片的背景进行极致增强：
1. 主体保持水晶般清晰
2. 极大增强背景的每个细节元素
3. 创造超现实的背景质感和深度
4. 让背景呈现电影级别的视觉效果
5. 背景与主体形成完美的和谐统一
请返回极致背景增强的图片。
''',

    'background_enhancer_5': '''
对这张图片的背景进行专业级增强：
1. 主体达到商业摄影标准
2. 背景达到专业广告级别的精细度
3. 创造完美的背景光影和氛围
4. 每个背景元素都精雕细琢
5. 呈现顶级商业摄影的背景品质
请返回专业级背景增强的图片。
''',

    'background_enhancer_6': '''
对这张图片的背景进行大师级增强：
1. 主体达到艺术品级别
2. 背景呈现大师级的艺术化处理
3. 创造富有诗意的背景氛围
4. 每个背景细节都具有艺术价值
5. 达到艺术收藏品的背景水准
请返回大师级背景增强的图片。
''',

    'background_enhancer_7': '''
对这张图片的背景进行终极增强：
1. 主体达到完美状态
2. 背景重新创造为艺术杰作
3. 每个像素都经过精心雕琢
4. 背景成为视觉的诗歌和梦境
5. 创造超越现实的背景美学
6. 达到传世艺术品的背景境界
请返回终极背景增强的图片。
''',

    // ==================== Face Retouch 面部修饰系列 (0-7) ====================
    'face_retouch_0': '''
保持人像面部完全原样，不进行任何修饰处理。
请返回与输入图片面部完全相同的图片。
''',

    'face_retouch_1': '''
对这张人像进行轻微的面部修饰：
1. 轻微平滑肌肤质感，去除明显瑕疵
2. 保持面部特征和表情完全自然
3. 微调肌肤色调，让其更加均匀
4. 轻微增强眼部的亮度和清晰度
5. 确保修饰后仍然真实自然
请返回轻微面部修饰的人像图片。
''',

    'face_retouch_2': '''
对这张人像进行中等程度的面部修饰：
1. 平滑肌肤纹理，去除大部分瑕疵
2. 保持重要的面部特征和个性
3. 优化肌肤色调和光泽度
4. 增强眼部和唇部的细节
5. 让面部看起来更加精致
请返回中等面部修饰的人像图片。
''',

    'face_retouch_3': '''
对这张人像进行高级面部修饰：
1. 深度平滑肌肤，创造完美质感
2. 保持自然的面部结构和表情
3. 优化面部光影和立体感
4. 精细处理眼部、鼻部、唇部细节
5. 达到专业摄影的修饰标准
请返回高级面部修饰的人像图片。
''',

    'face_retouch_4': '''
对这张人像进行极致面部修饰：
1. 创造无瑕疵的完美肌肤质感
2. 保持人物的独特气质和魅力
3. 优化每个面部细节到极致
4. 创造梦幻般的肌肤光泽
5. 达到时尚杂志封面的标准
请返回极致面部修饰的人像图片。
''',

    'face_retouch_5': '''
对这张人像进行专业级面部修饰：
1. 应用顶级商业摄影修饰技术
2. 创造完美而自然的面部效果
3. 每个面部区域都达到专业标准
4. 呈现奢侈品广告级别的质感
5. 保持人物的真实魅力和个性
请返回专业级面部修饰的人像图片。
''',

    'face_retouch_6': '''
对这张人像进行大师级面部修饰：
1. 应用艺术大师级的修饰技法
2. 创造如艺术品般的面部效果
3. 每个细节都经过精心雕琢
4. 呈现超越现实的美学标准
5. 达到艺术肖像的经典水准
请返回大师级面部修饰的人像图片。
''',

    'face_retouch_7': '''
对这张人像进行终极面部修饰：
1. 重新定义面部美学的极限
2. 创造超越时代的完美面容
3. 每个像素都达到艺术品级别
4. 呈现令人窒息的面部美感
5. 成就不朽的经典肖像作品
6. 达到传世肖像画的艺术高度
请返回终极面部修饰的人像图片。
''',

    // ==================== Face Enhancer 面部增强系列 (0-7) ====================
    'face_enhancer_0': '''
保持人像面部完全原样，不进行任何增强处理。
请返回与输入图片面部完全相同的图片。
''',

    'face_enhancer_1': '''
对这张人像面部进行轻微增强：
1. 轻微提升面部区域的清晰度
2. 增强五官的自然轮廓
3. 优化面部光线，增加微妙层次
4. 保持人物完全自然的特征
5. 让面部看起来更加精神有活力
请返回轻微面部增强的人像图片。
''',

    'face_enhancer_2': '''
对这张人像面部进行中等增强：
1. 显著提升面部清晰度和细节
2. 增强五官轮廓的立体感
3. 优化面部光影效果
4. 让眼部更加明亮有神
5. 整体提升面部的精神状态
请返回中等面部增强的人像图片。
''',

    'face_enhancer_3': '''
对这张人像面部进行高强度增强：
1. 大幅提升面部区域的所有细节
2. 强化五官的立体感和轮廓
3. 创造完美的面部光影效果
4. 让每个面部特征更加突出
5. 呈现非常精神和自信的状态
请返回高强度面部增强的人像图片。
''',

    'face_enhancer_4': '''
对这张人像面部进行极致增强：
1. 极大增强面部的每个细节
2. 创造超现实的五官立体感
3. 优化面部的每一寸光影
4. 让面部呈现完美的比例
5. 达到超模级别的面部效果
请返回极致面部增强的人像图片。
''',

    'face_enhancer_5': '''
对这张人像面部进行专业级增强：
1. 应用顶级肖像摄影增强技术
2. 创造商业级别的面部效果
3. 每个面部特征都达到完美
4. 呈现奢华品牌代言人的气质
5. 达到国际超模的面部标准
请返回专业级面部增强的人像图片。
''',

    'face_enhancer_6': '''
对这张人像面部进行大师级增强：
1. 应用艺术大师的肖像技法
2. 创造如雕塑般完美的面部
3. 每个细节都具有艺术价值
4. 呈现古典艺术的面部美学
5. 达到文艺复兴肖像的水准
请返回大师级面部增强的人像图片。
''',

    'face_enhancer_7': '''
对这张人像面部进行终极增强：
1. 重新定义人类面部美学的极限
2. 创造超越现实的完美面容
3. 每个像素都经过艺术升华
4. 呈现神话般的面部美感
5. 成就永恒经典的肖像杰作
6. 达到艺术史上的传世作品高度
请返回终极面部增强的人像图片。
''',
  };

  /// 获取默认提示词（当指定的级别提示词不存在时）
  static String _getDefaultPrompt(String toolId, int level) {
    debugPrint('⚠️ PromptService: 未找到 ${toolId}_$level 的提示词，使用默认');
    return '''
对这张图片进行 $toolId 效果处理，强度级别：$level
请根据效果类型和强度级别进行相应的图片处理。
''';
  }

  /// 获取效果级别名称
  static List<String> getLevelNames() {
    return [
      'Off',
      'Low',
      'Medium',
      'High',
      'Extreme',
      'Pro',
      'Master',
      'Ultimate',
    ];
  }

  /// 检查是否为付费级别
  static bool isProLevel(int level) {
    return level >= 2; // 2-7都是付费级别
  }

  /// 构建系统级提示词（添加通用要求）
  static String buildSystemPrompt(String userPrompt) {
    return '''
【系统要求】
- 严格按照用户要求处理图片
- 保持高质量输出
- 确保处理结果自然真实
- 不要添加用户未要求的元素

【用户要求】
$userPrompt
''';
  }
}
